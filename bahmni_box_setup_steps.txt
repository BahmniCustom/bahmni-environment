Guide To INSTALL Bahmni Software on a CentOS Minimal System
===============================================================


1. Install CentosOS (Minimal) 
  http://wiki.centos.org/Manuals/ReleaseNotes/CentOSMinimalCD6.5
  For example:
  download "CentOS-6.5-x86_64-minimal.iso" from http://centos.mirror.net.in/centos/6.5
  - In Virtual Box create a new Virtual Image (Bahmni_CentOS) and give its type as Red Hat Linux with 1.5GB RAM and 20 GB Virtual HDD. Leave other options as default.
  - Click on "Storage" window and select new CD/DVD drive option, to specify the CentOS ISO Image which you downloaded.
  - Start the newly created virtual box image. It will show you the INSTALL Wizard for CentOS.
  
  NOTE: 
  a) It is mandatory to choose CentOS MINIMAL, so that no older versions of software like PostGRES or JAVA get installed. These will otherwise conflict 
  with the current puppet scripts. Its best to have just a basic system, and let the puppet scripts do all the installations.
  b) If you need to have a UI / Browser also running on this machine, then choose CentOS MINIMAL + DESKTOP. 


2. Check if properly networked.
    2.1. In VirtualBox, choose bridged network to connect to internet.
    2.2. Run "ifconfig" and make sure eth0 has proper IP. You should be able to ping google. Else try "ifup eth0". Check ifconfig again.
   
3. Install git - "sudo yum install git"

4. Install ruby (187)
    sudo yum install ruby
   
5.  a) Install Puppet - (http://docs.puppetlabs.com/guides/installation.html#red-hat-enterprise-linux-and-derivatives)
       sudo rpm -ivh http://yum.puppetlabs.com/el/6/products/x86_64/puppetlabs-release-6-7.noarch.rpm
       sudo yum install puppet

    b) (Optional step): Edit the /etc/puppet/puppet.conf file and make an entry (This will ensure that manifest are executed sequentially):
       ordering = manifest 

6. Clone Bahmni-Environment repo in /root/bahmni -
    mkdir -p /root/bahmni
    cd /root/bahmni
    git clone https://github.com/Bhamni/bahmni-environment.git
    cd bahmni-environment


7. Install wget
   sudo yum install wget

8. Mkdir /packages

9. Copy localrepo, servers, tools to /packages/
  (You could do scp. Like: 'scp -r * root@10.4.31.206:/packages/' from the folder which has all your folders)

10. Provision
    cd /root/bahmni/bahmni-environment
    ./scripts/deploy-puppet-manifest.sh provision

11. 
    Create openmrs db (user root/password): openmrs
    Create OpenERP DB: (psql with user postgres and then grant owner to openerp): openerp
    (Alter database openerp owner to openerp)


12. Download & install latest BAHMNI build from ci.
    ./scripts/deploy-puppet-manifest.sh download-build
    

13. Deploy the JSS Build (Note this has some JSS specific configuration)   
    ./scripts/deploy-puppet-manifest.sh deploy-jss
    (If on deploy you get an error for JDK or tools.jar, ensure your default java is latest 1.7, and not old java1.5. If it is, then rename old java and create new sym link: 'ln -s /usr/java/default/bin/java /usr/bin/java')      


14. 
    Check if the following URLs are accessible:
    (May need to restart the box once)
    OpenERP:                      http://<IP>:8069/ (admin/password)
    OpenMRS:                      https://<IP>/openmrs  (admin/test)
    OpenELIS:                     http://<IP>:8080/openelis/ (admin/adminADMIN!)
    Bahmni:                       http://<IP>/home (admin/test) --- May need to give roles to user in OpenMRS if you see blank dashboard
    Reference Data (Grails app):  http://<IP>/reference-data/

    NOTE: To switch off IPTables in case your browser can't hit: 'service iptables stop'

15. Misc Configuration Steps:
    -------------------------
    - OpenELIS needs an Organization to be defined. Right now its JSS, but will need to be different per implementation. Do this in "Administration" screen.
    - The ATOM Feed properties file for elis needs organization entry. Set this to appropriate value:
    reference.data.default.organization=JSS
    (openelis/WEB-INF/classes/atomfeed.properties)
    - There is an issue with Address Hierarchy, so if you don't see the Registration Screen, then in OpenMRS, navigate to Address Hierarchy Screen. This will fix the issue.
    - You may also need to add "Diagnostics" data.

16. For OpenERP, follow these steps post-install:
   
      1) Install the following Modules:  
        - Warehouse Module
        - Sales Module
        - Purchase Module
        - Account and Finance Module

      When asked about the Financial Account system choose: (INR, 0, 0, Indian Account System)

      2) Setting, config, warehouse -> Track Serial Number, Expiry Date on Serial Number, Manage Multiple Location, And Manage diff UOProducts
      3) Settings, config, General Settings -> Allow user to import data from csv files
      4) Settings, users, Administrator choose (Edit) — access rights, select Technical Features. 

      5) Logout from OpenERP and then re-Login
      6) Install Bahmni Module Install (which installs all Bahmni OpenERP dependent modules)
      7) Ensure these are also installed: 
        - Bahmni Purchase flow enhancement
        - Bahmni Print Bill
        - Bahmni Seed Data install 
        - Don’t install Lab seed data
        - Don’t install DHIS2 stock export
      8) Uninstall Bahmni Logger   


===================================================================================================
Some todos we identified
===================================================================================================
TODO:

- [Fixed] The sequence in which local repo is created is arbitrary. MySQL install fails first time when you provision, and the repo gets created later.
Need to ensure that local repo is created first. 
- remove local packages dependencies - remove (require yum repo) 
------ create a new provision.pp file which will install all packages from internet.
------ Note that mySQL installation requires addition of another yum repo. This will be needed for Internet-mode installation.
- remove goServer
- Check how to enable download of packages, currently script downloads through public ip of GO of all current builds. we might not to use GO for package download and/or the bleeding packages 
* delete - /packages/localrepo ?